steps:
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA", "."]

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA"]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "$REPO_NAME"
      - "--image"
      - "gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA"
      - "--region"
      - "us-central1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--min-instances=0"
      - "--max-instances=1"
      - "--cpu=1"
      - "--memory=128Mi"
      - "--set-env-vars=GOOGLE_CLOUD_PROJECT=$PROJECT_ID,ENV=production"
      - "--set-secrets=MAILERSEND_API_KEY=mailersend-apikey:latest,ACCESS_TOKEN_SECRET=access-token-secret:latest,REFRESH_TOKEN_SECRET=refresh-token-secret:latest,ENCRYPTION_KEY=encryption-key:latest,MONGO_URI=mongo-uri:latest,APPLE_PRIVATE_KEY=apple-private-key:latest"
    secretEnv:
      [
        "MAILERSEND_API_KEY",
        "ACCESS_TOKEN_SECRET",
        "REFRESH_TOKEN_SECRET",
        "ENCRYPTION_KEY",
        "MONGO_URI",
        "APPLE_PRIVATE_KEY",
      ]

images:
  - "gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA"

options:
  logging: CLOUD_LOGGING_ONLY

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/MAILERSEND_API_KEY/versions/latest
      env: "MAILERSEND_API_KEY"
    - versionName: projects/$PROJECT_ID/secrets/ACCESS_TOKEN_SECRET/versions/latest
      env: "ACCESS_TOKEN_SECRET"
    - versionName: projects/$PROJECT_ID/secrets/REFRESH_TOKEN_SECRET/versions/latest
      env: "REFRESH_TOKEN_SECRET"
    - versionName: projects/$PROJECT_ID/secrets/ENCRYPTION_KEY/versions/latest
      env: "ENCRYPTION_KEY"
    - versionName: projects/$PROJECT_ID/secrets/MONGO_URI/versions/latest
      env: "MONGO_URI"
    - versionName: projects/$PROJECT_ID/secrets/APPLE_PRIVATE_KEY/versions/latest
      env: "APPLE_PRIVATE_KEY"
